{% extends "base.html" %}
{% load static %}
{% block extrahead %}
<link rel="stylesheet" href="{% static 'css/index.css' %}">
{% endblock extrahead %}
{% block content %}
<script src="https://unpkg.com/magic-grid@3.1.2/dist/magic-grid.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery.dotdotdot/4.0.11/dotdotdot.js"></script>
<script src="https://unpkg.com/vue"></script>
<script src="https://unpkg.com/vue-router"></script>
<script src="https://unpkg.com/vuex"></script>
<div class="container">
    <div id="app" v-cloak>        
        <post-list v-bind:posts="posts"></post-list>
    </div>

    <template id="post-list-template">
        <div  class="container-post">
            <post 
                v-for="post in posts"
                v-bind:title="post.title"
                v-bind:content="post.content"
            ></post>
         
        </div>
    </template>

    <template id="post-template">
        <div class="post mb-4 overflow-hidden">
            <h2 class="post-title" v-html="title"></h2>
            <div class="post-content" v-html="content"></div>
        </div>
    </template>

    {% comment %} <div class="container-post">
        {% for post in posts %}
        <div class="post mb-4 overflow-hidden" data-post-slug="{{ post.slug }}">
            <!-- post images -->
            {% if post.images.all.count > 0 %}
            <div class="w-100 d-flex flex-row">
                {% for image in post.images.all %}
                <div class="flex-grow-1">
                    <img class="w-100" src="{{ image.img_file.url }}" />
                </div>
                {% endfor %}
            </div>
            {% endif %}
            <!-- end post images -->

            {% if post.title %}
            <h2 class="post-title">{{ post.title }}</h2>
            {% endif %}


            <div class="post-content">{{ post.content| safe }}</div>

            <!-- post tag -->
            {% if post.tag.all.count %}
            <div class="p-3">
                <div class="tags">
                    {% for tag in post.tag.all %}
                    <a href="{% url 'tag_detail' tag.slug %}"
                        class="tag badge badge-pill badge-dark font-weight-normal">{{ tag }}</a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            <!-- end post tag -->
        </div>
        {% endfor %}
    </div> {% endcomment %}
</div>

<script>
   

    const store = new Vuex.Store({
        state: {
            posts: [
                { title: "test title", slug: "test-slug", content: "test contetttn" }
            ],
        },     

        mutations: {
            appendPost(state, posts) {
                state.posts = state.posts.concat(posts);                
                console.log("get muta: ", state.posts)
            }
        }
    });

    PostList = Vue.component('post-list', {        
        props: ['posts'],
        template: "#post-list-template"
    });

    Post = Vue.component('post', {        
        props: ['title', 'content'],
        template: "#post-template",
    });

    var app = new Vue({ 
        delimiters: ['[[', ']]'],
        el: '#app',
        store,       
        computed: {
            posts() {
                return store.state.posts
            }
        }
    });

    {% comment %} let magicGrid = new MagicGrid({
        container: '.container-post',
        animate: true,
        gutter: 15,
        static: true,
        useMin: true
    });

    magicGrid.listen(); {% endcomment %}

    $(".post-content").dotdotdot();

    $('.post').click(function (event) {
        let slug = $(this).data().postSlug;

        if (!event.target.className.includes('tag')) {
            window.location.href = slug
        }
    });
    nextUrl = "http://127.0.0.1:8000/api/post-list/?limit=3&offset=3";
     console.log('post list update');
            $.ajax({
                url: "/api/post-list", 
                success: function(res) {                                  
                    store.commit('appendPost', res.results);      
                    nextUrl = res.next;                   
                }
            })    

    $(window).on("scroll", function() {
	var scrollHeight = $(document).height();
	var scrollPosition = $(window).height() + $(window).scrollTop();
	if ((scrollHeight - scrollPosition) / scrollHeight === 0) {
	         console.log('post list update');
             $.ajax({
                url: nextUrl,
                success: function(res) {                                  
                    store.commit('appendPost', res.results);      
                    nextUrl = res.next;                   
                }
            })   
	}
});

</script>
{%endblock%}